#!/bin/sh

# bismark-mserver TCP and UDP throughput (netperf) measurements

set -o nounset
set -o errexit

# Load configuration
. /etc/bismark-mserver.conf

export NETSERVER_PARENT="BISMARK_$$"
netserver -4 -p $NETPERF_PORT >> /tmp/bismark-mserver-netperf.log 2>&1 &

if [ ! -z ${1:-} ]; then
    case "$1" in
    echopid)
        pids=$(ps -ef | awk '$8=="netserver" { print $2 }')
        for pid in $pids
        do
            if [ $(strings "/proc/$pid/environ" | \
                   grep -c "NETSERVER_PARENT=$NETSERVER_PARENT") -gt 0 ]; then
                    echo "$pid"
                    break
            fi
        done
        ;;
    *)
        echo "Usage: $0 [echopid]"
        exit 1
        ;;
    esac
fi
